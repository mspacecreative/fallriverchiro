/*!
 * Justified Gallery - v3.4.0
 * http://miromannino.com/projects/justified-gallery/
 * Copyright (c) 2014 Miro Mannino
 * Licensed under the MIT license.
 */
!(function(e){e.fn.justifiedGallery=function(t){function r(e,t,n){var r;r=e>t?e:t;if(r<=100){return n.settings.sizeRangeSuffixes.lt100}else if(r<=240){return n.settings.sizeRangeSuffixes.lt240}else if(r<=320){return n.settings.sizeRangeSuffixes.lt320}else if(r<=500){return n.settings.sizeRangeSuffixes.lt500}else if(r<=640){return n.settings.sizeRangeSuffixes.lt640}else{return n.settings.sizeRangeSuffixes.lt1024}}function i(e,t){return e.indexOf(t,e.length-t.length)!==-1}function s(e,t){return e.substring(0,e.length-t.length)}function o(e,t){var n=false;for(var r in t.settings.sizeRangeSuffixes){if(t.settings.sizeRangeSuffixes[r].length===0){n=true;continue}if(i(e,t.settings.sizeRangeSuffixes[r])){return t.settings.sizeRangeSuffixes[r]}}if(n)return"";else throw"unknown suffix for "+e}function u(e,t,n,i){var u=e.match(i.settings.extension);var a=u!=null?u[0]:"";var f=e.replace(i.settings.extension,"");f=s(f,o(f,i));f+=r(t,n,i)+a;return f}function a(t){var n=e(t.currentTarget).find(".sgg-caption");if(t.data.settings.cssAnimation){n.addClass("caption-visible").removeClass("caption-hidden")}else{n.stop().fadeTo(t.data.settings.captionSettings.animationDuration,t.data.settings.captionSettings.visibleOpacity)}}function f(t){var n=e(t.currentTarget).find(".sgg-caption");if(t.data.settings.cssAnimation){n.removeClass("caption-visible").removeClass("caption-hidden")}else{n.stop().fadeTo(t.data.settings.captionSettings.animationDuration,t.data.settings.captionSettings.nonVisibleOpacity)}}function l(e,t,n){if(n.settings.cssAnimation){e.addClass("entry-visible");t()}else{e.stop().fadeTo(n.settings.imagesAnimationDuration,1,t)}}function c(e,t){if(t.settings.cssAnimation){e.removeClass("entry-visible")}else{e.stop().fadeTo(0,0)}}function h(t,n,r,i,s,o,c){function v(){if(p!==d){h.attr("src",d)}}var h=t.find("img");h.css("width",i);h.css("height",s);h.css("margin-left",-i/2);h.css("margin-top",-s/2);t.width(i);t.height(o);t.css("top",r);t.css("left",n);var p=h.attr("src");var d=u(p,i,s,c);h.one("error",function(){h.attr("src",h.data("jg.originalSrc"))});if(h.data("jg.loaded")==="skipped"){h.one("load",function(){l(t,v,c);h.data("jg.loaded","loaded")})}else{l(t,v,c)}var m=t.data("jg.captionMouseEvents");if(c.settings.captions===true){var g=t.find(".sgg-caption");if(g.length===0){var y=h.attr("alt");if(typeof y==="undefined")y=t.attr("title");if(typeof y!=="undefined"){g=e('<div class="sgg-caption"><span>'+y+"</span></div>");t.append(g)}}if(g.length!==0){if(!c.settings.cssAnimation){g.stop().fadeTo(c.settings.imagesAnimationDuration,c.settings.captionSettings.nonVisibleOpacity)}if(typeof m==="undefined"){m={mouseenter:a,mouseleave:f};t.on("mouseenter",undefined,c,m.mouseenter);t.on("mouseleave",undefined,c,m.mouseleave);t.data("jg.captionMouseEvents",m)}}}else{if(typeof m!=="undefined"){t.off("mouseenter",undefined,c,m.mouseenter);t.off("mouseleave",undefined,c,m.mouseleave);t.removeData("jg.captionMouseEvents")}}}function p(e,t){var n=e.settings;var r,i,s,o,u,a,f=true;var l=0;var c=e.galleryWidth-(e.buildingRow.entriesBuff.length-1)*n.margins;var h=c/e.buildingRow.aspectRatio;var p=e.buildingRow.width/c>n.justifyThreshold;if(t&&n.lastRow==="hide"&&!p){for(r=0;r<e.buildingRow.entriesBuff.length;r++){i=e.buildingRow.entriesBuff[r];if(n.cssAnimation)i.removeClass("entry-visible");else i.stop().fadeTo(0,0)}return-1}if(t&&!p&&n.lastRow==="nojustify")f=false;for(r=0;r<e.buildingRow.entriesBuff.length;r++){s=e.buildingRow.entriesBuff[r].find("img");o=s.data("jg.imgw")/s.data("jg.imgh");if(f){u=h*o;a=h}else{u=n.rowHeight*o;a=n.rowHeight}s.data("jg.jimgw",Math.ceil(u));s.data("jg.jimgh",Math.ceil(a));if(r===0||l>a)l=a}if(n.fixedHeight&&l>n.rowHeight)l=n.rowHeight;return{minHeight:l,justify:f}}function d(e){e.lastAnalyzedIndex=-1;e.buildingRow.entriesBuff=[];e.buildingRow.aspectRatio=0;e.buildingRow.width=0;e.offY=0}function v(e,t){var n=e.settings;var r,i,s,o,u=0;o=p(e,t);s=o.minHeight;if(t&&n.lastRow==="hide"&&s===-1){e.buildingRow.entriesBuff=[];e.buildingRow.aspectRatio=0;e.buildingRow.width=0;return}if(n.maxRowHeight>0&&n.maxRowHeight<s)s=n.maxRowHeight;else if(n.maxRowHeight===0&&1.5*n.rowHeight<s)s=1.5*n.rowHeight;for(var a=0;a<e.buildingRow.entriesBuff.length;a++){r=e.buildingRow.entriesBuff[a];i=r.find("img");h(r,u,e.offY,i.data("jg.jimgw"),i.data("jg.jimgh"),s,e);u+=i.data("jg.jimgw")+n.margins}e.$gallery.height(e.offY+s+(e.spinner.active?e.spinner.$el.innerHeight():0));if(!t||s<=e.settings.rowHeight&&o.justify){e.offY+=s+e.settings.margins;e.buildingRow.entriesBuff=[];e.buildingRow.aspectRatio=0;e.buildingRow.width=0;e.$gallery.trigger("jg.rowflush")}}function m(e){e.checkWidthIntervalId=setInterval(function(){var t=parseInt(e.$gallery.width(),10);if(e.galleryWidth!==t){e.galleryWidth=t;d(e);w(e,true)}},e.settings.refreshTime)}function g(e){clearInterval(e.intervalId);e.intervalId=setInterval(function(){if(e.phase<e.$points.length)e.$points.eq(e.phase).fadeTo(e.timeslot,1);else e.$points.eq(e.phase-e.$points.length).fadeTo(e.timeslot,0);e.phase=(e.phase+1)%(e.$points.length*2)},e.timeslot)}function y(e){clearInterval(e.intervalId);e.intervalId=null}function b(e){e.yield.flushed=0;if(e.imgAnalyzerTimeout!==null)clearTimeout(e.imgAnalyzerTimeout)}function w(e,t){b(e);e.imgAnalyzerTimeout=setTimeout(function(){E(e,t)},.001);E(e,t)}function E(t,n){var r=t.settings;var i;for(var s=t.lastAnalyzedIndex+1;s<t.entries.length;s++){var o=e(t.entries[s]);var u=o.find("img");if(u.data("jg.loaded")===true||u.data("jg.loaded")==="skipped"){i=s>=t.entries.length-1;var a=t.galleryWidth-(t.buildingRow.entriesBuff.length-1)*r.margins;var f=u.data("jg.imgw")/u.data("jg.imgh");if(a/(t.buildingRow.aspectRatio+f)<r.rowHeight){v(t,i);if(++t.yield.flushed>=t.yield.every){w(t,n);return}}t.buildingRow.entriesBuff.push(o);t.buildingRow.aspectRatio+=f;t.buildingRow.width+=f*r.rowHeight;t.lastAnalyzedIndex=s}else if(u.data("jg.loaded")!=="error"){return}}if(t.buildingRow.entriesBuff.length>0)v(t,true);if(t.spinner.active){t.spinner.active=false;t.$gallery.height(t.$gallery.height()-t.spinner.$el.innerHeight());t.spinner.$el.detach();y(t.spinner)}b(t);if(!n)t.$gallery.trigger("jg.complete");else t.$gallery.trigger("jg.resize")}function S(e){function n(e){if(typeof t.sizeRangeSuffixes[e]!=="string")throw"sizeRangeSuffixes."+e+" must be a string"}function r(e,t){if(typeof e[t]==="string"){e[t]=parseFloat(e[t],10);if(isNaN(e[t]))throw"invalid number for "+t}else if(typeof e[t]==="number"){if(isNaN(e[t]))throw"invalid number for "+t}else{throw t+" must be a number"}}var t=e.settings;if(typeof t.sizeRangeSuffixes!=="object")throw"sizeRangeSuffixes must be defined and must be an object";n("lt100");n("lt240");n("lt320");n("lt500");n("lt640");n("lt1024");r(t,"rowHeight");r(t,"maxRowHeight");if(t.maxRowHeight>0&&t.maxRowHeight<t.rowHeight){t.maxRowHeight=t.rowHeight}r(t,"margins");if(t.lastRow!=="nojustify"&&t.lastRow!=="justify"&&t.lastRow!=="hide"){throw'lastRow must be "nojustify", "justify" or "hide"'}r(t,"justifyThreshold");if(t.justifyThreshold<0||t.justifyThreshold>1)throw"justifyThreshold must be in the interval [0,1]";if(typeof t.cssAnimation!=="boolean"){throw"cssAnimation must be a boolean"}r(t.captionSettings,"animationDuration");r(t,"imagesAnimationDuration");r(t.captionSettings,"visibleOpacity");if(t.captionSettings.visibleOpacity<0||t.captionSettings.visibleOpacity>1)throw"captionSettings.visibleOpacity must be in the interval [0, 1]";r(t.captionSettings,"nonVisibleOpacity");if(t.captionSettings.visibleOpacity<0||t.captionSettings.visibleOpacity>1)throw"captionSettings.nonVisibleOpacity must be in the interval [0, 1]";if(typeof t.fixedHeight!=="boolean"){throw"fixedHeight must be a boolean"}if(typeof t.captions!=="boolean"){throw"captions must be a boolean"}r(t,"refreshTime");if(typeof t.randomize!=="boolean"){throw"randomize must be a boolean"}}var n={sizeRangeSuffixes:{lt100:"_t",lt240:"_m",lt320:"_n",lt500:"",lt640:"_z",lt1024:"_b"},rowHeight:120,maxRowHeight:0,margins:1,lastRow:"nojustify",justifyThreshold:.75,fixedHeight:false,waitThumbnailsLoad:true,captions:true,cssAnimation:false,imagesAnimationDuration:500,captionSettings:{animationDuration:500,visibleOpacity:.7,nonVisibleOpacity:0},rel:null,target:null,extension:/\.[^.\\/]+$/,refreshTime:100,randomize:false};return this.each(function(r,i){var s=e(i);s.addClass("justified-gallery");var o=s.data("jg.context");if(typeof o==="undefined"){if(typeof t!=="undefined"&&t!==null&&typeof t!=="object")throw"The argument must be an object";var u=e('<div class="spinner"><span></span><span></span><span></span></div>');o={settings:e.extend({},n,t),imgAnalyzerTimeout:null,entries:null,buildingRow:{entriesBuff:[],width:0,aspectRatio:0},lastAnalyzedIndex:-1,yield:{every:2,flushed:0},offY:0,spinner:{active:false,phase:0,timeslot:150,$el:u,$points:u.find("span"),intervalId:null},checkWidthIntervalId:null,galleryWidth:s.width(),$gallery:s};s.data("jg.context",o)}else if(t==="norewind"){for(var a=0;a<o.buildingRow.entriesBuff.length;a++){c(o.buildingRow.entriesBuff[a],o)}}else{o.settings=e.extend({},o.settings,t);d(o)}S(o);o.entries=s.find("> a, > div:not(.spinner)").toArray();if(o.entries.length===0)return;if(o.settings.randomize){o.entries.sort(function(){return Math.random()*2-1});e.each(o.entries,function(){e(this).appendTo(s)})}var f=false;e.each(o.entries,function(t,n){var r=e(n);var i=r.find("img");if(i.data("jg.loaded")!==true&&i.data("jg.loaded")!=="skipped"){if(o.settings.rel!==null)r.attr("rel",o.settings.rel);if(o.settings.target!==null)r.attr("target",o.settings.target);var u=typeof i.data("safe-src")!=="undefined"?i.data("safe-src"):i.attr("src");i.data("jg.originalSrc",u);i.attr("src",u);var a=parseInt(i.attr("width"),10);var l=parseInt(i.attr("height"),10);if(o.settings.waitThumbnailsLoad!==true&&!isNaN(a)&&!isNaN(l)){i.data("jg.imgw",a);i.data("jg.imgh",l);i.data("jg.loaded","skipped");w(o,false);return true}i.data("jg.loaded",false);f=true;if(o.spinner.active===false){o.spinner.active=true;s.append(o.spinner.$el);s.height(o.offY+o.spinner.$el.innerHeight());g(o.spinner)}var c=new Image;var h=e(c);h.one("load",function(){i.off("load error");i.data("jg.imgw",c.width);i.data("jg.imgh",c.height);i.data("jg.loaded",true);w(o,false)});h.one("error",function(){i.off("load error");i.data("jg.loaded","error");w(o,false)});c.src=u}});if(!f)w(o,false);m(o)})}})(jQuery)